# 多线程测试用例说明

本文档描述了为 `singleton-task` 库添加的完善多线程测试用例。

## 测试覆盖场景

### 1. 并发任务启动 (`test_concurrent_task_start`)

- **目的**: 测试多个线程同时启动任务的场景
- **场景**: 10个线程同时尝试启动长时间运行的任务
- **验证**: 由于单例特性，只有最后启动的任务会运行，其他任务会被取消
- **预期结果**: 至少有一个任务成功启动并运行

### 2. 快速任务替换 (`test_rapid_task_replacement`)

- **目的**: 测试任务快速替换的场景
- **场景**: 连续快速启动多个任务，每个任务间隔很短
- **验证**: 新任务会替换旧任务，最后一个任务能正常运行
- **预期结果**: 能接收到最后一个任务的输出数据

### 3. 错误处理多线程 (`test_error_handling_multithreaded`)

- **目的**: 测试在多线程环境下的错误处理
- **场景**: 启动多个可能失败的任务，部分成功部分失败
- **验证**: 错误能正确传播，成功的任务能正常运行
- **预期结果**: 既有成功的任务，也有失败的任务

### 4. 多任务快速启动 (`test_multiple_task_startup`)

- **目的**: 测试多个任务的快速启动和数据接收
- **场景**: 连续启动多个任务并尝试接收数据
- **验证**: 能从不同任务接收到数据
- **预期结果**: 接收到来自任务的消息

### 5. 并发停止 (`test_concurrent_stop`)

- **目的**: 测试多线程同时停止任务的场景
- **场景**: 多个线程同时尝试停止同一个任务
- **验证**: 停止操作能正确处理并发情况
- **预期结果**: 要么有成功的停止操作，要么接收到任务数据（证明任务曾运行）

### 6. 高并发场景 (`test_high_concurrency`)

- **目的**: 测试高并发情况下的任务管理
- **场景**: 同时启动大量（20个）并发任务，使用共享计数器
- **验证**: 在高并发下系统仍能正确工作
- **预期结果**: 有成功的任务启动，共享计数器被正确更新

## 测试辅助类型

### 错误类型

- `Error1`: 基本错误类型，用于大部分测试
- `Error2`: 扩展错误类型，包含超时和自定义错误，用于错误处理测试

### 任务类型

#### `LongRunningTask`

- **用途**: 模拟长时间运行的任务
- **特点**:
  - 可配置任务名称和执行间隔
  - 发送带任务名的消息
  - 支持优雅停止

#### `ErrorTask`

- **用途**: 模拟可能失败的任务
- **特点**:
  - 可配置失败条件
  - 在特定条件下抛出错误
  - 用于测试错误处理

#### `CounterTask`

- **用途**: 使用共享计数器的任务
- **特点**:
  - 使用 `Arc<Mutex<u32>>` 共享计数器
  - 每次执行递增计数器
  - 用于测试并发访问

## 测试验证要点

1. **单例特性**: 确保同时只有一个任务运行
2. **任务替换**: 新任务能正确替换旧任务
3. **错误处理**: 错误能正确传播和处理
4. **并发安全**: 多线程访问时的数据安全
5. **资源清理**: 任务停止时的资源正确释放
6. **消息传递**: 任务与外部的数据通信正常

## 运行说明

```bash
# 运行所有测试
cargo test

# 运行特定的多线程测试
cargo test test_concurrent_task_start
cargo test test_rapid_task_replacement
cargo test test_error_handling_multithreaded
cargo test test_multiple_task_startup
cargo test test_concurrent_stop
cargo test test_high_concurrency

# 带详细输出运行测试
cargo test -- --nocapture
```

## 注意事项

1. **测试时序**: 多线程测试依赖时序，可能在不同环境下表现略有差异
2. **资源清理**: 测试使用了 tokio 的多线程运行时，某些警告是正常的
3. **并发控制**: 测试中使用了适当的延迟来控制并发时序
4. **断言策略**: 考虑到单例任务的特性，断言条件设计得较为灵活

这些测试用例全面覆盖了 `singleton-task` 库在多线程环境下的各种使用场景，确保库的稳定性和正确性。
